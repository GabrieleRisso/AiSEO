

x-vpn-defaults: &vpn-defaults
  image: qmcgaw/gluetun
  cap_add:
    - NET_ADMIN
  devices:
    - /dev/net/tun:/dev/net/tun
  environment:
    - VPN_SERVICE_PROVIDER=protonvpn
    - VPN_TYPE=wireguard
    - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
    - HTTPPROXY=on
    - HTTPPROXY_PORT=8888
    # Enable control server for rotation
    - HTTP_CONTROL_SERVER_ADDRESS=:8000
    - HTTP_CONTROL_SERVER_LOG=on
    # Update servers daily
    - UPDATER_PERIOD=24h

services:
  # VPN 1: France
  vpn-fr:
    <<: *vpn-defaults
    container_name: vpn-fr
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=France
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8001:8888" # Proxy
      # - "9001:8000" # Control (optional, for local debugging)

  # VPN 2: Germany
  vpn-de:
    <<: *vpn-defaults
    container_name: vpn-de
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Germany
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8002:8888"

  # VPN 3: Netherlands
  vpn-nl:
    <<: *vpn-defaults
    container_name: vpn-nl
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Netherlands
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8003:8888"

  # VPN 4: Italy
  vpn-it:
    <<: *vpn-defaults
    container_name: vpn-it
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Italy
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8004:8888" # Gluetun HTTP Proxy
      - "8889:8889" # Residential Proxy Chaining (GOST)

  # Residential Proxy Sidecar for Italy (Chains VPN -> Bright Data)
  # Uses GOST to listen on 8889 (inside vpn-it network) and forward to Bright Data
  # Enforces Italy country targeting (-country-it) to match VPN location
  residential-proxy-it:
    image: ginuerzh/gost
    container_name: residential-proxy-it
    network_mode: "service:vpn-it"
    # Appends -country-it to username for geolocation targeting.
    # Omits -session to allow IP rotation by Bright Data.
    command: -L=:8889 -F=http://${BRIGHT_DATA_USER}-country-it:${BRIGHT_DATA_PASSWORD}@${BRIGHT_DATA_HOST}:${BRIGHT_DATA_PORT}
    depends_on:
      - vpn-it
    restart: unless-stopped

  # VPN 5: Spain
  vpn-es:
    <<: *vpn-defaults
    container_name: vpn-es
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Spain
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8005:8888"

  # VPN 6: United Kingdom
  vpn-uk:
    <<: *vpn-defaults
    container_name: vpn-uk
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=United Kingdom
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8006:8888"

  # VPN 7: Switzerland
  vpn-ch:
    <<: *vpn-defaults
    container_name: vpn-ch
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Switzerland
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8007:8888"

  # VPN 8: Sweden
  vpn-se:
    <<: *vpn-defaults
    container_name: vpn-se
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=Sweden
      - HTTPPROXY=on
      - HTTPPROXY_PORT=8888
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - UPDATER_PERIOD=24h
    ports:
      - "8008:8888"

  # VPN Manager (Rotates IPs)
  vpn-manager:
    build:
      context: .
      dockerfile: Dockerfile.scraper # Re-use python image
    container_name: vpn-manager
    depends_on:
      - vpn-fr
      - vpn-de
      - vpn-nl
      - vpn-it
      - vpn-es
      - vpn-uk
      - vpn-ch
      - vpn-se
    environment:
      - VPN_CONTAINERS=vpn-fr,vpn-de,vpn-nl,vpn-it,vpn-es,vpn-uk,vpn-ch,vpn-se
      - ROTATION_INTERVAL=600 # 10 minutes
      - PYTHONUNBUFFERED=1
    command: python scripts/vpn_manager.py

  # AiSEO Scraper
  scraper:
    build:
      context: .
      dockerfile: Dockerfile.scraper
    container_name: aiseo-scraper
    depends_on:
      - vpn-fr
      - vpn-de
      - vpn-nl
      - vpn-it
      - vpn-es
      - vpn-uk
      - vpn-ch
      - vpn-se
    volumes:
      - ./data:/app/data
      - ./scripts:/app/scripts
      - ./src:/app/src
    environment:
      - PROXY_FR=http://vpn-fr:8888
      - PROXY_DE=http://vpn-de:8888
      - PROXY_NL=http://vpn-nl:8888
      - PROXY_IT=http://vpn-it:8888
      - PROXY_ES=http://vpn-es:8888
      - PROXY_UK=http://vpn-uk:8888
      - PROXY_CH=http://vpn-ch:8888
      - PROXY_SE=http://vpn-se:8888
      - BRIGHTDATA_API_TOKEN=5c654f6c-c368-4e8e-976e-bcf9522a2f67
      - PYTHONUNBUFFERED=1
    ports:
      - "5000:5000"
    # Run the API service
    command: uvicorn src.scraper_api:app --host 0.0.0.0 --port 5000 --reload

  # AiSEO Backend API
  backend:
    build:
      context: backend
      dockerfile: Dockerfile
    container_name: aiseo-api
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./data:/app/data
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Database UI (sqlite-web)
  db-ui:
    image: coleifer/sqlite-web
    container_name: aiseo-db-ui
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/data
    command: sqlite_web /data/aiseo.db -H 0.0.0.0 -p 8080

  # API Tester Web Interface
  api-tester:
    build:
      context: ./api-tester
      dockerfile: Dockerfile
    container_name: aiseo-api-tester
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PORT=9000
    restart: unless-stopped
